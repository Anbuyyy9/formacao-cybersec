# üî• Laborat√≥rio de Firewall - Defesa e Monitoramento

## ‚ö° In√≠cio R√°pido (5 minutos)

```bash
# 1. Execute o script de setup
./scripts/setup-lab.sh

# 2. Acesse a interface gr√°fica
# Navegador: http://localhost:6080
# VNC: localhost:5901 (senha: kenseilab)

# 3. Teste a conectividade
docker exec -it kali_lab_19 /opt/lab-tools/test-lab.sh

# 4. Configure o firewall na interface gr√°fica
sudo iptables -L  # Ver regras atuais
```

## üìö Objetivo do Laborat√≥rio

Este laborat√≥rio pr√°tico tem como objetivo ensinar os conceitos fundamentais de firewall e controle de acesso √† rede atrav√©s do **iptables** no Linux. Voc√™ aprender√° a:

- Configurar regras de firewall para proteger sistemas
- Bloquear ataques maliciosos
- Permitir tr√°fego leg√≠timo e essencial
- Gerar logs para auditoria e diagn√≥stico
- Testar e validar configura√ß√µes de seguran√ßa

---

## üéØ Desafio da Aula: Firewall na Pr√°tica

### O Cen√°rio
Voc√™ √© o **administrador de rede** de uma empresa e precisa proteger um servidor Ubuntu contra ataques vindos de uma m√°quina Kali Linux. Sua miss√£o √©:

1. **Bloquear ataques maliciosos** vindos do Kali
2. **Permitir o tr√°fego leg√≠timo** (HTTP, conex√µes estabelecidas)
3. **Gerar logs detalhados** para auditoria e diagn√≥stico

### O que voc√™ deve entregar:
- ‚úÖ Regras de firewall configuradas
- ‚úÖ Capturas de tela (prints) do antes e depois
- ‚úÖ Descri√ß√£o da estrat√©gia e princ√≠pios utilizados

---

## üèóÔ∏è Arquitetura do Laborat√≥rio

| Container     | Papel                        | IP                  | Fun√ß√£o                    |
|---------------|------------------------------|---------------------|---------------------------|
| `kali_lab_19` | üéØ **M√°quina Atacante**      | 192.168.100.11      | Simula um atacante        |
| `ubuntu_lab_19` | üõ°Ô∏è **Servidor Alvo**        | 192.168.100.10      | Servidor a ser protegido  |
| `ubuntu_gui`  | üñ•Ô∏è **Interface Gr√°fica**     | 192.168.100.12      | Esta√ß√£o de trabalho       |

### Topologia de Rede:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Kali Linux    ‚îÇ    ‚îÇ   Ubuntu CLI    ‚îÇ    ‚îÇ   Ubuntu GUI    ‚îÇ
‚îÇ  (Atacante)     ‚îÇ    ‚îÇ   (Alvo)        ‚îÇ    ‚îÇ  (Esta√ß√£o)      ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ 192.168.100.11  ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ 192.168.100.10  ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ 192.168.100.12  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ Pr√©-requisitos

Antes de come√ßar, certifique-se de ter:

- [ ] **Docker** instalado e funcionando
- [ ] **Docker Compose** instalado
- [ ] Portas `6080` e `5901` livres no seu sistema
- [ ] Conhecimento b√°sico de Linux e redes

### Verificando os pr√©-requisitos:

```bash
# Verificar se o Docker est√° instalado
docker --version

# Verificar se o Docker Compose est√° instalado
docker-compose --version

# Verificar se as portas est√£o livres
netstat -tuln | grep -E ":(6080|5901)"
```

---

## üöÄ Passo a Passo: Configurando o Ambiente

### 1. Iniciando o Laborat√≥rio

```bash
# Clone ou navegue at√© o diret√≥rio do laborat√≥rio
cd lab_3

# Inicie todos os containers
docker-compose up -d

# Verifique se todos os containers est√£o rodando
docker ps
```

**Resultado esperado:**
```
CONTAINER ID   IMAGE                    COMMAND           CREATED         STATUS         PORTS                    NAMES
abc123...      kalilinux/kali-rolling   "sleep infinity"  2 minutes ago   Up 2 minutes                            kali_lab_19
def456...      ubuntu:22.04             "sleep infinity"  2 minutes ago   Up 2 minutes                            ubuntu_lab_19
ghi789...      consol/ubuntu-xfce-vnc   "/startup.sh"     2 minutes ago   Up 2 minutes   0.0.0.0:6080->6901/tcp   ubuntu_gui
```

### 2. Acessando a Interface Gr√°fica

Voc√™ tem duas op√ß√µes para acessar o Ubuntu com interface gr√°fica:

#### Op√ß√£o A: Via Navegador (Recomendado)
1. Abra seu navegador
2. Acesse: `http://localhost:6080`
3. Use as credenciais:
   - **Usu√°rio:** `root`
   - **Senha:** `kenseilab`

#### Op√ß√£o B: Via VNC Viewer
1. Instale um cliente VNC (como VNC Viewer)
2. Conecte em: `localhost:5901`
3. Use a senha: `kenseilab`

### 3. Preparando o Ambiente de Trabalho

**‚úÖ AMBIENTE PR√â-CONFIGURADO!** 

Os containers j√° v√™m com todas as ferramentas necess√°rias instaladas e configuradas. O script de setup automatiza todo o processo.

#### üîí Configura√ß√µes Autom√°ticas Inclu√≠das:

**Container Ubuntu GUI:**
- ‚úÖ iptables e iptables-persistent instalados
- ‚úÖ sudo configurado para usu√°rio `defaultuser`
- ‚úÖ Script wrapper `iptables-gui` criado
- ‚úÖ Script de teste `/opt/lab-scripts/test-firewall.sh`
- ‚úÖ Ferramentas de rede (nmap, curl, wget, etc.)

**Container Kali:**
- ‚úÖ sshpass instalado para automa√ß√£o SSH
- ‚úÖ Script de teste de conectividade
- ‚úÖ Ferramentas de pentesting (metasploit, nmap, etc.)

**Container Ubuntu:**
- ‚úÖ SSH server configurado e rodando
- ‚úÖ iptables instalado
- ‚úÖ Scripts de exemplo copiados

Para verificar se tudo est√° funcionando:

```bash
# Na interface gr√°fica (Ubuntu GUI):
sudo iptables -L          # Ver regras
# iptables-gui -L           # Script wrapper
# /opt/lab-scripts/test-firewall.sh  # Teste completo

# Via container Ubuntu:
docker exec -it ubuntu_lab_19 bash
iptables -L               # J√° como root

# Via container Kali:
docker exec -it kali_lab_19 bash
/opt/lab-tools/test-lab.sh  # Teste de conectividade
```

---

## üìñ Conceitos Te√≥ricos Importantes

### O que √© um Firewall?
Um **firewall** √© um sistema de seguran√ßa que monitora e controla o tr√°fego de rede baseado em regras predefinidas. Funciona como uma "barreira" entre redes confi√°veis e n√£o confi√°veis.

### Como funciona o iptables?
O **iptables** √© o firewall padr√£o do Linux que usa **tabelas** e **cadeias** para filtrar pacotes:

#### Tabelas Principais:
- **filter**: Filtragem de pacotes (padr√£o)
- **nat**: Network Address Translation
- **mangle**: Modifica√ß√£o de pacotes

#### Cadeias da Tabela Filter:
- **INPUT**: Pacotes destinados ao pr√≥prio sistema
- **OUTPUT**: Pacotes originados do pr√≥prio sistema
- **FORWARD**: Pacotes que passam pelo sistema (roteador)

#### Pol√≠ticas Padr√£o:
- **ACCEPT**: Permitir o tr√°fego
- **DROP**: Descartar o pacote silenciosamente
- **REJECT**: Rejeitar o pacote com mensagem de erro

---

## üîß Passo a Passo: Configurando o Firewall

### Fase 1: An√°lise Inicial (Antes das Regras)

Primeiro, vamos testar a conectividade **antes** de aplicar as regras de firewall:

#### 1.1 Testando SSH do Kali para o Ubuntu

```bash
# Acesse o terminal do Kali (j√° configurado)
docker exec -it kali_lab_19 bash

# ‚úÖ TUDO J√Å EST√Å INSTALADO E CONFIGURADO!
# - SSH client: ‚úÖ Instalado
# - nmap: ‚úÖ Instalado
# - Ferramentas de rede: ‚úÖ Instaladas

# Teste conectividade com o Ubuntu
ping -c 3 192.168.100.10

# Teste SSH (deve funcionar inicialmente)
ssh root@192.168.100.10
# Digite 'yes' para aceitar a chave
# Digite 'exit' para sair

# OU use o script de teste autom√°tico:
/opt/lab-tools/test-lab.sh
```

#### 1.2 Verificando Portas Abertas

```bash
# No Kali, escaneie as portas do Ubuntu
nmap -sS -p- 192.168.100.10

# Teste HTTP (se houver servi√ßo web)
curl http://192.168.100.10
```

**üì∏ TIRE UM PRINT** dos resultados para comparar depois!

### Fase 2: Configurando as Regras de Firewall

Agora vamos configurar o firewall no Ubuntu para proteg√™-lo:

#### 2.1 Acessando o Ubuntu Alvo

```bash
# Acesse o terminal do Ubuntu (j√° configurado)
docker exec -it ubuntu_lab_19 bash

# ‚úÖ TUDO J√Å EST√Å INSTALADO E CONFIGURADO!
# - iptables: ‚úÖ Instalado
# - SSH: ‚úÖ Instalado e rodando
# - Ferramentas: ‚úÖ nmap, curl, wget, sudo, etc.

# Verificar se SSH est√° rodando
service ssh status

# Se n√£o estiver rodando, inicie:
service ssh start
```

#### 2.2 Aplicando as Regras de Firewall

Execute as seguintes regras **uma por vez** e entenda o que cada uma faz:

```bash
# 1. Limpar todas as regras existentes
iptables -F
iptables -X

# 2. Definir pol√≠tica padr√£o: NEGAR TUDO (princ√≠pio de seguran√ßa)
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 3. Permitir conex√µes j√° estabelecidas (importante!)
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 4. Permitir tr√°fego local (loopback)
iptables -A INPUT -i lo -j ACCEPT

# 5. Permitir HTTP (porta 80) - tr√°fego leg√≠timo
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 6. BLOQUEAR SSH do Kali (192.168.100.11) - ataque malicioso
iptables -A INPUT -s 192.168.100.11 -p tcp --dport 22 -j DROP

# 7. Permitir SSH de outros IPs (opcional - para administra√ß√£o)
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 8. Adicionar logging para auditoria
iptables -A INPUT -s 192.168.100.11 -j LOG --log-prefix "BLOCKED_KALI: "
```

#### 2.3 Verificando as Regras Aplicadas

```bash
# Ver todas as regras configuradas
iptables -L -v -n

# Ver regras com n√∫meros de linha
iptables -L --line-numbers

# Ver estat√≠sticas
iptables -L -v
```

### Fase 3: Testando as Regras (Depois)

Agora vamos testar se as regras est√£o funcionando:

#### 3.1 Testando Bloqueio do SSH

```bash
# No Kali, tente conectar via SSH novamente
ssh root@192.168.100.10
# Deve ser BLOQUEADO!
```

#### 3.2 Verificando Logs

```bash
# No Ubuntu, verifique os logs
tail -f /var/log/syslog | grep BLOCKED_KALI
```

#### 3.3 Testando Conectividade

```bash
# No Kali, teste ping (deve funcionar)
ping -c 3 192.168.100.10

# Teste HTTP (deve funcionar se houver servi√ßo)
curl http://192.168.100.10

# Escaneie portas novamente
nmap -sS -p- 192.168.100.10
```

**üì∏ TIRE UM PRINT** dos resultados para comparar com o antes!

---

## üéØ Desafio Pr√°tico

### Objetivo
Configure regras de firewall que implementem a **pol√≠tica de seguran√ßa** da empresa:

### Requisitos:
1. **Bloquear completamente** o acesso SSH do Kali (192.168.100.11) ao Ubuntu
2. **Permitir** tr√°fego HTTP (porta 80)
3. **Permitir** conex√µes j√° estabelecidas
4. **Gerar logs** de todas as tentativas de acesso bloqueadas
5. **Permitir** SSH de outros IPs para administra√ß√£o

### Regras Sugeridas:
```bash
# Suas regras aqui...
iptables -F
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Adicione suas regras personalizadas aqui
```

### Testes Obrigat√≥rios:
- [ ] SSH do Kali ‚Üí Ubuntu (deve ser BLOQUEADO)
- [ ] Ping do Kali ‚Üí Ubuntu (deve FUNCIONAR)
- [ ] HTTP do Kali ‚Üí Ubuntu (deve FUNCIONAR)
- [ ] SSH de outro IP ‚Üí Ubuntu (deve FUNCIONAR)
- [ ] Logs de tentativas bloqueadas (deve APARECER)

---

## üìä An√°lise e Documenta√ß√£o

### O que documentar:

#### 1. Regras Aplicadas
```bash
# Cole aqui suas regras finais
iptables -L -v -n
```

#### 2. Testes Realizados
| Teste | Antes | Depois | Status |
|-------|-------|--------|--------|
| SSH Kali‚ÜíUbuntu | ‚úÖ | ‚ùå | Bloqueado |
| Ping Kali‚ÜíUbuntu | ‚úÖ | ‚úÖ | Funciona |
| HTTP Kali‚ÜíUbuntu | ‚ùì | ‚ùì | ? |
| SSH Outro IP‚ÜíUbuntu | ‚ùì | ‚ùì | ? |

#### 3. Logs Capturados
```bash
# Cole aqui os logs de tentativas bloqueadas
grep BLOCKED_KALI /var/log/syslog
```

#### 4. Screenshots
- [ ] Print da tela antes das regras
- [ ] Print da tela depois das regras
- [ ] Print dos logs de bloqueio
- [ ] Print dos testes de conectividade

---

## üß† Princ√≠pios de Seguran√ßa Aplicados

### 1. **Princ√≠pio do Menor Privil√©gio**
- Negar tudo por padr√£o
- Permitir apenas o necess√°rio

### 2. **Defesa em Profundidade**
- M√∫ltiplas camadas de prote√ß√£o
- Logs para auditoria

### 3. **Fail-Safe**
- Se algo der errado, o sistema fica seguro
- Pol√≠tica padr√£o DROP

### 4. **Monitoramento Cont√≠nuo**
- Logs de todas as tentativas
- Auditoria de acessos

---

## üîç Troubleshooting

### ‚ö†Ô∏è Problemas Comuns e Solu√ß√µes

#### 1. **Permiss√µes de Root / Sudo n√£o encontrado**
```bash
# PROBLEMA: "sudo: command not found" ou "Permission denied"
# SOLU√á√ÉO: Use o usu√°rio root diretamente

# No container Ubuntu:
su -                    # Virar root
# OU
docker exec -it ubuntu_lab_19 bash  # J√° entra como root

# Execute comandos sem sudo:
apt update && apt upgrade -y
iptables -L
```

#### 2. **"Connection refused" no SSH**
```bash
# Verifique se o SSH est√° rodando
service ssh status

# Inicie se necess√°rio
service ssh start

# Verifique se a porta 22 est√° aberta
netstat -tuln | grep :22
```

#### 3. **Regras de firewall n√£o funcionam**
```bash
# Verifique a ordem das regras
iptables -L --line-numbers

# As regras s√£o processadas em ordem!
# Regras mais espec√≠ficas devem vir ANTES das gerais

# Verifique se as regras foram aplicadas
iptables -L -v -n
```

#### 4. **Logs n√£o aparecem**
```bash
# Verifique se o logging est√° ativo
dmesg | grep BLOCKED

# Ou
tail -f /var/log/syslog

# Verifique se a regra de logging foi adicionada
iptables -L | grep LOG
```

#### 5. **Container n√£o responde**
```bash
# Reinicie o container
docker restart ubuntu_lab_19

# Verifique se est√° rodando
docker ps

# Verifique logs do container
docker logs ubuntu_lab_19
```

#### 6. **Problemas de conectividade**
```bash
# Teste ping entre containers
docker exec kali_lab_19 ping -c 3 192.168.100.10
docker exec ubuntu_lab_19 ping -c 3 192.168.100.11

# Verifique se a rede est√° funcionando
docker network ls
docker network inspect lab_3_cybersec_lab_19
```

### üîß Script de Troubleshooting Automatizado

Para diagn√≥stico autom√°tico de problemas:

```bash
# Execute o script de troubleshooting
./scripts/troubleshooting.sh
```

Este script ir√°:
- ‚úÖ Verificar se todos os containers est√£o rodando
- ‚úÖ Testar conectividade de rede
- ‚úÖ Verificar servi√ßos essenciais
- ‚úÖ Diagnosticar problemas de permiss√µes
- ‚úÖ Sugerir corre√ß√µes autom√°ticas
- ‚úÖ Mostrar comandos √∫teis

---

## üìö Comandos √öteis para o Laborat√≥rio

### Gerenciamento de Containers:
```bash
# Ver containers rodando
docker ps

# Acessar terminal do Kali
docker exec -it kali_lab_19 bash

# Acessar terminal do Ubuntu
docker exec -it ubuntu_lab_19 bash

# Parar todos os containers
docker-compose down

# Reiniciar containers
docker-compose restart
```

### Comandos iptables:
```bash
# Ver regras
iptables -L -v -n

# Ver regras com n√∫meros
iptables -L --line-numbers

# Ver estat√≠sticas
iptables -L -v

# Salvar regras (Ubuntu)
iptables-save > /etc/iptables/rules.v4

# Carregar regras
iptables-restore < /etc/iptables/rules.v4
```

### Testes de Conectividade:
```bash
# Ping
ping -c 3 192.168.100.10

# SSH
ssh root@192.168.100.10

# Nmap
nmap -sS -p- 192.168.100.10

# Curl
curl http://192.168.100.10
```

---

## üéì Conclus√£o

Ao final deste laborat√≥rio, voc√™ ter√°:

‚úÖ **Compreendido** os conceitos fundamentais de firewall  
‚úÖ **Configurado** regras de seguran√ßa com iptables  
‚úÖ **Testado** e validado configura√ß√µes de prote√ß√£o  
‚úÖ **Implementado** logging para auditoria  
‚úÖ **Aplicado** princ√≠pios de seguran√ßa em rede  

### Pr√≥ximos Passos:
- Explore regras mais avan√ßadas (rate limiting, NAT)
- Configure firewalls em outros sistemas
- Implemente IDS/IPS
- Estude ferramentas como UFW e firewalld

---

## üõ†Ô∏è Scripts e Ferramentas

### Setup Automatizado (Recomendado)
```bash
# Executar setup completo do laborat√≥rio
./scripts/setup-lab.sh
```
**‚úÖ Inclui:**
- Build dos containers personalizados
- Instala√ß√£o autom√°tica de todas as ferramentas
- Configura√ß√£o do SSH
- Scripts de configura√ß√£o r√°pida

### Configura√ß√£o R√°pida (Dentro dos Containers)
```bash
# No Ubuntu: Configurar firewall rapidamente
docker exec -it ubuntu_lab_19 /opt/lab-scripts/quick-setup.sh

# No Kali: Testar conectividade
docker exec -it kali_lab_19 /opt/lab-tools/test-lab.sh
```

### Teste de Configura√ß√µes
```bash
# Testar se as regras de firewall est√£o funcionando
./scripts/test-firewall.sh
```

### Troubleshooting
```bash
# Diagnosticar e corrigir problemas
./scripts/troubleshooting.sh
```

### Exemplo de Configura√ß√£o
```bash
# Ver exemplo de regras de firewall
cat scripts/iptables-example.sh
```

## üìö Documenta√ß√£o Adicional

- **[Checklist do Laborat√≥rio](docs/checklist-laboratorio.md)** - Acompanhe seu progresso
- **[Exemplos Pr√°ticos](docs/exemplos-praticos.md)** - Casos de uso avan√ßados
- **[Solu√ß√£o de Problemas](docs/solucao-problemas.md)** - Guia r√°pido para problemas comuns
- **[Script de Setup](scripts/setup-lab.sh)** - Configura√ß√£o automatizada
- **[Script de Teste](scripts/test-firewall.sh)** - Valida√ß√£o das configura√ß√µes
- **[Script de Troubleshooting](scripts/troubleshooting.sh)** - Diagn√≥stico e corre√ß√£o de problemas

## üìû Suporte

Se encontrar problemas:
1. Execute o script de setup: `./scripts/setup-lab.sh`
2. Execute o script de teste: `./scripts/test-firewall.sh`
3. Verifique os logs do Docker: `docker-compose logs`
4. Reinicie os containers: `docker-compose restart`
5. Consulte a documenta√ß√£o do iptables
6. Pe√ßa ajuda no grupo do WhatsApp

**Bom estudo e boa sorte no desafio! üöÄ**
